/*
    Vitia Invenire - Generic Malware Detection Rules
    Detects common malware indicators including shellcode, RATs, post-exploitation tools,
    and webshells. These rules target widely-documented patterns from public threat intelligence.
*/

rule Metasploit_Meterpreter_Reverse_TCP
{
    meta:
        description = "Detects Metasploit Meterpreter reverse TCP shellcode patterns"
        severity = "CRITICAL"
        reference = "https://github.com/rapid7/metasploit-framework"
        category = "shellcode"

    strings:
        // Meterpreter reverse TCP stage - WSAStartup, socket, connect sequence
        $ws2_32_load = { 6A 00 53 FF D5 6A 05 68 }
        // socket(AF_INET, SOCK_STREAM, IPPROTO_TCP)
        $socket_call = { 6A 00 6A 01 6A 02 FF D5 }
        // Meterpreter config block marker
        $meterpreter_config = "metsrv.dll" ascii wide
        // Reflective DLL injection stub
        $reflective_loader = { 4D 5A 52 45 }
        // Meterpreter transport strings
        $transport_reverse_tcp = "reverse_tcp" ascii
        $transport_reverse_https = "reverse_https" ascii

    condition:
        ($ws2_32_load and $socket_call) or
        ($meterpreter_config and $reflective_loader) or
        (all of ($transport_*) and $reflective_loader)
}

rule CobaltStrike_Beacon_Indicators
{
    meta:
        description = "Detects Cobalt Strike Beacon payload indicators"
        severity = "CRITICAL"
        reference = "https://www.cobaltstrike.com/"
        category = "c2"

    strings:
        // Cobalt Strike default named pipe patterns
        $pipe_1 = "\\\\.\\pipe\\msagent_" ascii
        $pipe_2 = "\\\\.\\pipe\\MSSE-" ascii
        $pipe_3 = "\\\\.\\pipe\\postex_" ascii
        $pipe_4 = "\\\\.\\pipe\\status_" ascii
        // Beacon config markers
        $config_1 = { 00 01 00 01 00 02 }
        $config_2 = { 69 68 69 68 69 6B }
        // Beacon sleep mask deobfuscation
        $sleep_mask = { 4C 8B 53 08 45 8B 0A 45 8B 5A 04 4D 8D 52 08 45 85 C9 }
        // Default Beacon user-agent
        $ua_beacon = "Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0)" ascii
        // Malleable C2 default
        $malleable = "/submit.php?id=" ascii

    condition:
        2 of ($pipe_*) or
        ($config_1 and $config_2) or
        $sleep_mask or
        ($ua_beacon and $malleable)
}

rule Mimikatz_Indicators
{
    meta:
        description = "Detects Mimikatz credential dumping tool strings"
        severity = "CRITICAL"
        reference = "https://github.com/gentilkiwi/mimikatz"
        category = "credential_theft"

    strings:
        $str_1 = "mimikatz" ascii wide nocase
        $str_2 = "gentilkiwi" ascii wide
        $str_3 = "sekurlsa" ascii wide
        $str_4 = "kerberos::golden" ascii wide
        $str_5 = "lsadump::sam" ascii wide
        $str_6 = "privilege::debug" ascii wide
        $str_7 = "sekurlsa::logonpasswords" ascii wide
        $str_8 = "sekurlsa::wdigest" ascii wide
        $str_9 = "dpapi::masterkey" ascii wide
        $str_10 = "token::elevate" ascii wide
        // Mimikatz PE version info
        $ver_1 = "Benjamin DELPY" ascii wide
        $ver_2 = "Outil de diagnostics de securite" ascii wide

    condition:
        3 of ($str_*) or
        all of ($ver_*)
}

rule njRAT_Indicators
{
    meta:
        description = "Detects njRAT (Bladabindi) remote access trojan configuration patterns"
        severity = "CRITICAL"
        reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.njrat"
        category = "rat"

    strings:
        // njRAT mutex and registry patterns
        $njrat_1 = "netsh firewall add allowedprogram" ascii wide
        $njrat_2 = "SEE_MASK_NOZONECHECKS" ascii wide
        $njrat_3 = "cmd.exe /c ping 0 -n 2 & del" ascii wide
        // njRAT keylogger markers
        $njrat_4 = "[kl]" ascii wide
        // njRAT config delimiters
        $delim_1 = "|'|'|" ascii wide
        $delim_2 = "Y262SUCZ4F" ascii wide
        // njRAT .NET class names
        $class_1 = "njq8" ascii wide
        $class_2 = "njRAT" ascii wide

    condition:
        3 of them
}

rule AsyncRAT_Indicators
{
    meta:
        description = "Detects AsyncRAT remote access trojan patterns"
        severity = "CRITICAL"
        reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.asyncrat"
        category = "rat"

    strings:
        // AsyncRAT config class members
        $cfg_1 = "AsyncMutex" ascii wide
        $cfg_2 = "AsyncRAT" ascii wide
        $cfg_3 = "Pastebin" ascii wide
        $cfg_4 = "ServerSignature" ascii wide
        $cfg_5 = "Anti_Process" ascii wide
        // AsyncRAT C2 communication markers
        $comm_1 = "Received!" ascii wide
        $comm_2 = "ClientSocket" ascii wide
        $comm_3 = "SslStream" ascii wide
        // AsyncRAT plugin loading
        $plugin_1 = "Invoke" ascii wide
        $plugin_2 = "DynamicInvoke" ascii wide

    condition:
        ($cfg_2 and 2 of ($cfg_*)) or
        (3 of ($cfg_*) and 2 of ($comm_*))
}

rule Generic_Webshell_PHP
{
    meta:
        description = "Detects common PHP webshell patterns"
        severity = "CRITICAL"
        reference = "Generic webshell detection"
        category = "webshell"

    strings:
        $eval_1 = "eval($_POST[" ascii nocase
        $eval_2 = "eval($_GET[" ascii nocase
        $eval_3 = "eval($_REQUEST[" ascii nocase
        $eval_4 = "eval(base64_decode(" ascii nocase
        $eval_5 = "assert($_POST[" ascii nocase
        $shell_1 = "system($_GET[" ascii nocase
        $shell_2 = "passthru($_POST[" ascii nocase
        $shell_3 = "shell_exec($_REQUEST[" ascii nocase
        // Common webshell strings
        $ws_1 = "FilesMan" ascii nocase
        $ws_2 = "b374k" ascii nocase
        $ws_3 = "c99shell" ascii nocase
        $ws_4 = "r57shell" ascii nocase
        $ws_5 = "WSO " ascii

    condition:
        any of ($eval_*) or
        any of ($shell_*) or
        2 of ($ws_*)
}

rule Generic_Webshell_ASPX
{
    meta:
        description = "Detects common ASP.NET webshell patterns"
        severity = "CRITICAL"
        reference = "Generic webshell detection"
        category = "webshell"

    strings:
        $asp_1 = "cmd.exe /c" ascii wide
        $asp_2 = "Process.Start" ascii wide
        $asp_3 = "ProcessStartInfo" ascii wide
        $asp_4 = "Request.Form[" ascii wide
        $asp_5 = "Request.QueryString[" ascii wide
        // China Chopper webshell one-liner pattern
        $chopper_1 = "eval(Request.Item[" ascii wide
        $chopper_2 = "unsafe" ascii wide
        // ASPX shell indicators
        $aspx_1 = "runat=\"server\"" ascii nocase
        $aspx_2 = "System.Diagnostics" ascii wide
        $aspx_3 = "System.IO.File" ascii wide

    condition:
        ($chopper_1) or
        ($aspx_1 and $asp_1 and ($asp_2 or $asp_3)) or
        ($aspx_1 and $aspx_2 and any of ($asp_*))
}

rule Reverse_Shell_Indicators
{
    meta:
        description = "Detects common reverse shell patterns across scripting languages"
        severity = "CRITICAL"
        reference = "Generic reverse shell detection"
        category = "backdoor"

    strings:
        // PowerShell reverse shell
        $ps_1 = "New-Object System.Net.Sockets.TCPClient" ascii wide nocase
        $ps_2 = "Net.Sockets.TCPClient" ascii wide nocase
        $ps_3 = "$stream = $client.GetStream()" ascii wide nocase
        // Python reverse shell
        $py_1 = "socket.socket(socket.AF_INET" ascii
        $py_2 = "subprocess.call([\"/bin/sh\"" ascii
        $py_3 = "subprocess.call([\"cmd.exe\"" ascii
        $py_4 = "os.dup2(s.fileno()" ascii
        // Bash reverse shell patterns (may appear in scripts on Windows)
        $bash_1 = "/dev/tcp/" ascii
        $bash_2 = "bash -i >& /dev/tcp/" ascii
        // Netcat reverse shell
        $nc_1 = "nc -e /bin/sh" ascii
        $nc_2 = "nc.exe -e cmd.exe" ascii
        $nc_3 = "ncat -e cmd.exe" ascii

    condition:
        ($ps_1 and $ps_3) or
        ($py_1 and ($py_2 or $py_3 or $py_4)) or
        any of ($bash_*) or
        any of ($nc_*)
}

rule SliverC2_Implant
{
    meta:
        description = "Detects Sliver C2 framework implant indicators"
        severity = "CRITICAL"
        reference = "https://github.com/BishopFox/sliver"
        category = "c2"

    strings:
        // Sliver implant Go package paths (appear in Go binaries)
        $go_1 = "github.com/bishopfox/sliver" ascii
        $go_2 = "sliverpb" ascii
        // Sliver implant config indicators
        $cfg_1 = "ActiveC2" ascii
        $cfg_2 = "BeaconInterval" ascii
        $cfg_3 = "BeaconJitter" ascii
        // Sliver named pipe default
        $pipe_1 = "\\\\.\\pipe\\sliverpivot" ascii

    condition:
        any of ($go_*) or
        (all of ($cfg_*)) or
        $pipe_1
}

rule BruteRatel_C4_Indicators
{
    meta:
        description = "Detects Brute Ratel C4 (BRc4) post-exploitation framework indicators"
        severity = "CRITICAL"
        reference = "https://bruteratel.com/"
        category = "c2"

    strings:
        // BRc4 badger configuration markers
        $brc4_1 = "badger_" ascii wide
        $brc4_2 = "brc4" ascii wide nocase
        // BRc4 DOH (DNS over HTTPS) C2 patterns
        $doh_1 = "dns.google/resolve" ascii wide
        $doh_2 = "cloudflare-dns.com/dns-query" ascii wide
        // BRc4 default config encryption pattern
        $config_marker = { 41 42 43 44 45 46 47 48 }
        // BRc4 LDAP sentinel strings
        $ldap_1 = "badger_new" ascii
        $ldap_2 = "coffloader" ascii

    condition:
        2 of ($brc4_*) or
        ($config_marker and any of ($doh_*)) or
        all of ($ldap_*)
}
